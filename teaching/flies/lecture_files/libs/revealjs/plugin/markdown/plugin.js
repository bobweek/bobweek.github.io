/*!
 * The reveal.js markdown plugin. Handles parsing of
 * markdown inside of presentations as well as loading
 * of external markdown documents.
 */
import{marked}from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_VERTICAL_SEPARATOR=null,DEFAULT_NOTES_SEPARATOR="^s*notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[\s*((\d*):)?\s*([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{function t(t){let e=(t.querySelector("[data-template]")||t.querySelector("script")||t).textContent;e=e.replace(new RegExp(SCRIPT_END_PLACEHOLDER,"g"),"</script>");const r=e.match(/^\n?(\s*)/)[1].length,a=e.match(/^\n?(\t*)/)[1].length;return a>0?e=e.replace(new RegExp("\\n?\\t{"+a+"}(.*)","g"),function(t,e){return"\n"+e}):r>1&&(e=e.replace(new RegExp("\\n? {"+r+"}(.*)","g"),function(t,e){return"\n"+e})),e}function e(t){const e=t.attributes,r=[];for(let t=0,a=e.length;t<a;t++){const a=e[t].name,n=e[t].value;/data\-(markdown|separator|vertical|notes)/gi.test(a)||(n?r.push(a+'="'+n+'"'):r.push(a))}return r.join(" ")}function r(t){const e=d?.getConfig?.().markdown;return(t=t||{}).separator=t.separator||e?.separator||DEFAULT_SLIDE_SEPARATOR,t.verticalSeparator=t.verticalSeparator||e?.verticalSeparator||DEFAULT_VERTICAL_SEPARATOR,t.notesSeparator=t.notesSeparator||e?.notesSeparator||DEFAULT_NOTES_SEPARATOR,t.attributes=t.attributes||"",t}function a(t,e){e=r(e);const a=t.split(new RegExp(e.notesSeparator,"mgi"));return 2===a.length&&(t=a[0]+'<aside class="notes">'+marked(a[1].trim())+"</aside>"),'<script type="text/template">'+(t=t.replace(/<\/script>/g,SCRIPT_END_PLACEHOLDER))+"</script>"}function n(t,e){e=r(e);const n=new RegExp(e.separator+(e.verticalSeparator?"|"+e.verticalSeparator:""),"mg"),o=new RegExp(e.separator);let s,i,c,l=0,u=!0,d=[];for(;s=n.exec(t);){i=o.test(s[0]),!i&&u&&d.push([]),c=t.substring(l,s.index),i&&u?d.push(c):d[d.length-1].push(c),l=n.lastIndex,u=i}(u?d:d[d.length-1]).push(t.substring(l));let E="";for(let t=0,r=d.length;t<r;t++)d[t]instanceof Array?(E+="<section "+e.attributes+">",d[t].forEach(function(t){E+="<section data-markdown>"+a(t,e)+"</section>"}),E+="</section>"):E+="<section "+e.attributes+" data-markdown>"+a(d[t],e)+"</section>";return E}function o(r){return new Promise(function(a){const o=[];[].slice.call(r.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach(function(r){r.getAttribute("data-markdown").length?o.push(s(r).then(function(t){r.outerHTML=n(t.responseText,{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:e(r)})},function(t,e){r.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+e+" failed with HTTP status "+t.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"})):r.outerHTML=n(t(r),{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:e(r)})}),Promise.all(o).then(a)})}function s(t){return new Promise(function(e,r){const a=new XMLHttpRequest,n=t.getAttribute("data-markdown"),o=t.getAttribute("data-charset");null!==o&&""!==o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(t,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?e(a,n):r(a,n))}.bind(this,t,a),a.open("GET",n,!0);try{a.send()}catch(t){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+t),e(a,n)}})}function i(t,e,r){const a=new RegExp(r,"mg"),n=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg");let o,s,i=t.nodeValue;if(o=a.exec(i)){const r=o[1];for(i=i.substring(0,o.index)+i.substring(a.lastIndex),t.nodeValue=i;s=n.exec(r);)s[2]?e.setAttribute(s[1],s[2]):e.setAttribute(s[3],"");return!0}return!1}function c(t,e,r,a,n){if(null!==e&&void 0!==e.childNodes&&e.childNodes.length>0){let r=e;for(let o=0;o<e.childNodes.length;o++){const s=e.childNodes[o];if(o>0){let t=o-1;for(;t>=0;){const a=e.childNodes[t];if("function"==typeof a.setAttribute&&"BR"!==a.tagName){r=a;break}t-=1}}let i=t;"section"===s.nodeName&&(i=s,r=s),"function"!=typeof s.setAttribute&&s.nodeType!==Node.COMMENT_NODE||c(i,s,r,a,n)}}e.nodeType===Node.COMMENT_NODE&&!1===i(e,r,a)&&i(e,t,n)}function l(){const e=d.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(e).forEach(function(e){e.setAttribute("data-markdown-parsed",!0);const r=e.querySelector("aside.notes"),a=t(e);e.innerHTML=marked(a),c(e,e,null,e.getAttribute("data-element-attributes")||e.parentNode.getAttribute("data-element-attributes")||DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR,e.getAttribute("data-attributes")||e.parentNode.getAttribute("data-attributes")||DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR),r&&e.appendChild(r)}),Promise.resolve()}function u(t){return t.replace(/([&<>'"])/g,t=>HTML_ESCAPE_MAP[t])}let d;return{id:"markdown",init:function(t){d=t;let{renderer:e,animateLists:r,...a}=d.getConfig().markdown||{};return e||(e=new marked.Renderer,e.code=(t,e)=>{let r="",a="";if(CODE_LINE_NUMBER_REGEX.test(e)){let t=e.match(CODE_LINE_NUMBER_REGEX)[2];t&&(r=`data-ln-start-from="${t.trim()}"`),a=e.match(CODE_LINE_NUMBER_REGEX)[3].trim(),a=`data-line-numbers="${a}"`,e=e.replace(CODE_LINE_NUMBER_REGEX,"").trim()}return`<pre><code ${a} ${r} class="${e}">${t=u(t)}</code></pre>`}),!0===r&&(e.listitem=t=>`<li class="fragment">${t}</li>`),marked.setOptions({renderer:e,...a}),o(d.getRevealElement()).then(l)},processSlides:o,convertSlides:l,slidify:n,marked:marked}};export default Plugin;