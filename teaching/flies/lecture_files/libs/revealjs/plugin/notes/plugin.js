import speakerViewHTML from"./speaker-view.html";import{marked}from"marked";const Plugin=()=>{function e(){if(c&&!c.closed)c.focus();else{if(c=window.open("about:blank","reveal.js - Notes","width=1100,height=700"),c.marked=marked,c.document.write(speakerViewHTML),!c)return void alert("Speaker view popup failed to open. Please make sure popups are allowed and reopen the speaker view.");n()}}function t(e){c&&!c.closed?c.focus():(c=e,window.addEventListener("message",i),s())}function n(){const e=d.getConfig().url,t="string"==typeof e?e:window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;l=setInterval(function(){c.postMessage(JSON.stringify({namespace:"reveal-notes",type:"connect",state:d.getState(),url:t}),"*")},500),window.addEventListener("message",i)}function a(e,t,n){let a=d[e].apply(d,t);c.postMessage(JSON.stringify({namespace:"reveal-notes",type:"return",result:a,callId:n}),"*")}function o(){let e=d.getCurrentSlide(),t=e.querySelectorAll("aside.notes"),n=e.querySelector(".current-fragment"),a={namespace:"reveal-notes",type:"state",notes:"",markdown:!1,whitespace:"normal",state:d.getState()};if(e.hasAttribute("data-notes")&&(a.notes=e.getAttribute("data-notes"),a.whitespace="pre-wrap"),n){let e=n.querySelector("aside.notes");e?(a.notes=e.innerHTML,a.markdown="string"==typeof e.getAttribute("data-markdown"),t=null):n.hasAttribute("data-notes")&&(a.notes=n.getAttribute("data-notes"),a.whitespace="pre-wrap",t=null)}t&&t.length&&(t=Array.from(t).filter(e=>null===e.closest(".fragment")),a.notes=t.map(e=>e.innerHTML).join("\n"),a.markdown=t[0]&&"string"==typeof t[0].getAttribute("data-markdown")),c.postMessage(JSON.stringify(a),"*")}function r(e){try{return window.location.origin===e.source.location.origin}catch(e){return!1}}function i(e){if(r(e))try{let t=JSON.parse(e.data);t&&"reveal-notes"===t.namespace&&"connected"===t.type?(clearInterval(l),s()):t&&"reveal-notes"===t.namespace&&"call"===t.type&&a(t.methodName,t.arguments,t.callId)}catch(e){}}function s(){d.on("slidechanged",o),d.on("fragmentshown",o),d.on("fragmenthidden",o),d.on("overviewhidden",o),d.on("overviewshown",o),d.on("paused",o),d.on("resumed",o),o()}let l,d,c=null;return{id:"notes",init:function(n){d=n,/receiver/i.test(window.location.search)||(null!==window.location.search.match(/(\?|\&)notes/gi)?e():window.addEventListener("message",e=>{if(!c&&"string"==typeof e.data){let n;try{n=JSON.parse(e.data)}catch(e){}n&&"reveal-notes"===n.namespace&&"heartbeat"===n.type&&t(e.source)}}),d.addKeyBinding({keyCode:83,key:"S",description:"Speaker notes view"},function(){e()}))},open:e}};export default Plugin;